name: genai-toolkit
services:
    chromadb:
        image: us-docker.pkg.dev/gcnv-ai-dev/genai-toolkit/chromadb:v0.2
        container_name: chromadb
        volumes:
            - /databases/chromadb:/chroma/chroma
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat" ]
            interval: 30s
            timeout: 10s
            retries: 3

    postgres:
        image: us-docker.pkg.dev/gcnv-ai-dev/genai-toolkit/postgres:v0.2
        container_name: postgres
        environment:
            POSTGRES_DB: genai-toolkit-db
            POSTGRES_USER: admin
            POSTGRES_PASSWORD: admin
        volumes:
            - /databases/postgres:/var/lib/postgresql/data

    genai-toolkit-api:
        stop_signal: SIGINT
        image: us-docker.pkg.dev/gcnv-ai-dev/genai-toolkit/genai-toolkit-api:v0.2
        container_name: genai-toolkit-api
        privileged: true
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8001/health/"]
            interval: 10s
            timeout: 10s
            retries: 10
        environment:
            ROOT_DIR: /root_dir
            CHROMA_HOST: chromadb
            POSTGRES_HOST: postgres
            POSTGRES_DB: genai-toolkit-db
            LOG_HTTP_REQUESTS: FALSE
            JWT_ACCESS_TOKEN_EXPIRES: 5
            JWT_AUTH_REQUIRED: TRUE
            JWT_SECRET_KEY: JWT_SECRET_KEY_PLACEHOLDER
            GOOGLE_REGION: GOOGLE_REGION_PLACEHOLDER
            GOOGLE_PROJECT_ID: GOOGLE_PROJECT_ID_PLACEHOLDER
            GOOGLE_API_KEY: GOOGLE_API_KEY_PLACEHOLDER
            GOOGLE_AI_ENDPOINT: GOOGLE_AI_ENDPOINT_PLACEHOLDER
            OPENAI_API_KEY: OPENAI_API_KEY_PLACEHOLDER
            OPENAI_ENDPOINT: OPENAI_ENDPOINT_PLACEHOLDER
            GOOGLE_APPLICATION_CREDENTIALS: /root/.config/gcloud/service_account.json
        volumes:
            - /root/credentials.json:/root/.config/gcloud/service_account.json
            - /volumes/gcnv:/root_dir/gcnv
            - /volumes/ontap:/root_dir/ontap
            - /cache/api:/app/.cache
        depends_on:
            - chromadb
            - postgres

    genai-toolkit-ui:
        image: us-docker.pkg.dev/gcnv-ai-dev/genai-toolkit/genai-toolkit-ui:v0.2
        container_name: genai-toolkit-ui
        depends_on:
            genai-toolkit-api:
                condition: service_healthy

    nginx:
        image: us-docker.pkg.dev/gcnv-ai-dev/genai-toolkit/nginx:v0.2
        container_name: nginx
        ports:
            - "80:80"
            - "443:443"
            - "8001:8001"
        depends_on:
            - genai-toolkit-api
            - genai-toolkit-ui
